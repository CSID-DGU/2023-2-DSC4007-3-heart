<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>

* {
  box-sizing: border-box;
}

body {
  background-color: #edeff2;
  font-family: "Calibri", "Roboto", sans-serif;
}
.chat_window {
  position: absolute;
  width: 470px;
  height: 600px;
  border-radius: 10px;
  background-color: #fff;
  left: 50%;
  top: 50%;
  transform: translateX(-50%) translateY(-50%);
  box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
  background-color: #fff;
  overflow: hidden;
}

.top_menu {
  width: 100%;
  background-color: #FBAB7E;
  background-image: linear-gradient(62deg, #FBAB7E 0%, #F7CE68 100%);

  padding: 20px 0 25px;
  box-shadow: 0 1px 30px rgba(0, 0, 0, 0.1);
}

.top_menu .button{
  width: 40px;
  height: 40px;
  margin-left: 40px;
  border:none;
  float: left;
  background: url("../images/home3.png");
  background-size : cover
  
}

.top_menu .title {
  text-align: center;
  color: #000000;
  font-size: 20px;
  font-weight: bold;
}

.top_menu .copybutton {
  width: 40px;
  height: 40px;
  margin-right: 40px;
  float: right;
  background: url("../images/printer.png");
  background-size: cover;
  border: none;
  
}


.messages {
  position: relative;
  list-style: none;
  padding: 10px 10px 0 20px;
  margin: 0;
  height: calc(100% - 150px);
  overflow: scroll;
  
}

.message_title{
  text-align: center;
  font-size: 17px;
  font-weight: bold;
  padding: 20px 10px 10px 10px;
}

.message_text {
  font-weight: bold;
  cursor: pointer;
  color: #0b0b0b;
  text-align: center;
  background-color: #f7f6f4;
  padding: 15px 10px 10px 15px;
  border-radius: 10px;
  margin-bottom: 10px;
  transition: background-color 0.3s;
  
}

.message_text:hover {
  background-color: #ffbb68;
}

.messages .message {
  clear: both;
  overflow: hidden;
  margin-bottom: 20px;
  transition: all 0.5s linear;
  opacity: 0;
}

.messages .message.left .avatar {
  background-color: #fff0ec;
  float: left;
}
.messages .message.left .text_wrapper {
  background-color: #f5f5f5;
  margin-left: 20px;
}
.messages .message.left .text_wrapper::after, .messages .message.left .text_wrapper::before {
  right: 100%;
  border-right-color: #f5f5f5;
}
.messages .message.left .text {
  color: #000000;
}
.messages .message.left .avatar {
  float: left;
  width: 60px;
  height: 50px;
  background-image: url("https://pas-wordpress-media.s3.amazonaws.com/wp-content/uploads/2013/08/Customer-service-woman-on-headset-gives-OK-1024x770.jpg");
  background-size: cover;
  border-radius: 50%;
  margin-right: 10px;
}

.messages .message.right .text_wrapper {
  background-color: #ffe6cb;
  margin-right: 20px;
  float: right;
}
.messages .message.right .text_wrapper::after, .messages .message.right .text_wrapper::before {
  left: 100%;
  border-left-color: #ffe6cb;
}
.messages .message.right .text {
  color: #000000;
  
}
.messages .message.appeared {
  opacity: 1;
}
.messages .message .avatar {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  display: inline-block;
}
.messages .message .text_wrapper {
  display: inline-block;
  padding: 20px;
  border-radius: 6px;
  width: calc(100% - 100px);
  min-width: 100px;
  position: relative;
}
.messages .message .text_wrapper::after, .messages .message .text_wrapper:before {
  top: 18px;
  border: solid transparent;
  content: " ";
  height: 0;
  width: 0;
  position: absolute;
  pointer-events: none;
}
.messages .message .text_wrapper::after {
  border-width: 13px;
  margin-top: 0px;
}
.messages .message .text_wrapper::before {
  border-width: 15px;
  margin-top: -2px;
}
.messages .message .text_wrapper .text {
  font-size: 18px;
  font-weight: bold;
}

.bottom_wrapper {
  position: relative;
  width: 100%;
  background-color: #fff;
  padding: 15px 20px;
  position: absolute;
  bottom: 0;
}
.bottom_wrapper .message_input_wrapper {
  display: inline-block;
  height: 50px;
  border-radius: 25px;
  border: 1px solid #bcbdc0;
  width: calc(100% - 160px);
  position: relative;
  padding: 0 20px;
}
.bottom_wrapper .message_input_wrapper .message_input {
  border: none;
  height: 100%;
  box-sizing: border-box;
  width: calc(100% - 40px);
  position: absolute;
  outline-width: 0;
  color: gray;
}
.bottom_wrapper .send_message {
  width: 140px;
  height: 50px;
  display: inline-block;
  border-radius: 50px;
  background-color: #FBAB7E;
  background-image: linear-gradient(62deg, #FBAB7E 0%, #F7CE68 100%);
  border: 1px solid #FF8C00;
  color: white;
  cursor: pointer;
  transition: all 0.2s linear;
  text-align: center;
  float: right;
}
.bottom_wrapper .send_message:hover {
  color: #FF8C00;
  background-color: #fff;
  background-image:none;
}
.bottom_wrapper .send_message .text {
  font-size: 18px;
  font-weight: 300;
  display: inline-block;
  line-height: 48px;
}

.done_button{
  width: calc(100%);
  min-width: 100px;
  height: calc(100%);
  border:none;
  font-size: 13px;
  font-weight: bold;
  padding : 10px 10px 10px 10px;
  margin-top:5px;
  margin-bottom:5px;
  background-color: white;
  color: black;
  cursor: pointer;
  border-radius: 5px;
}

.done_button:hover{
  color: #FF8C00;
  background-color: #fff;
  border-color: #FF8C00;
  border:none;
}

#loading {
	width: 100%;
	height: 100%;
	top: 0;
	left: 0;
	position: fixed;
	display: block;
	opacity: 0.8;
	background: white;
	z-index: 99;
	text-align: center;
}



#loading > img {
	position: absolute;
	top: 50%;
	left: 50%;
	z-index: 100;
}
 </style>


    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
</head>




<body>
<div class="chat_window">

    <div class="top_menu">
        <img src="{{ url_for('static', filename='images/home3.png') }}" class="button">
        <img src="{{ url_for('static', filename='images/printer.png') }}" class="copybutton">
        <div class="title">민원상담 챗봇 마음이</div>
        
        
    </div>
    <!--메세지 창-->
    <ul class="messages" id="capture">
      <div class="message_title">안녕하세요. 마음 챗봇입니다. 무엇을 도와드릴까요?</div>
      <div class="message_text" >1.생활지원</div>
      <div class="message_text" >2.주거지원</div>
      <div class="message_text" >3.건강의료</div>
      <div class="message_text" >4.고용,일자리</div>
      <div class="message_text" >5.돌봄</div>
      <div class="message_text" >6.기타</div>
    </ul>
    <div class="bottom_wrapper clearfix">
        <div class="message_input_wrapper">
            <input class="message_input" placeholder="입력해주세요.." />
        </div>
        <div class="send_message">
            <div class="icon"></div>
            <div class="text">전송하기</div>
        </div>
    </div>
    
    <div class="message_template">
    <li class="message">
        
        <div class="text_wrapper">
            <div class="text">
              <!--<div id="loading">
                <img src="{{ url_for('static', filename='images/loading.gif') }}" alt="loading">
                </div>-->
            </div>
        </div>
    </li>
    </div>
    

    </div>
</div>




<script>

// type_data 딕셔너리
var type_data = [{
    "1.생활지원" :{
      "question1": "노인 목욕비 지원",
      "question2": "체육 지원",
      "question3": "교통비 지원",
      "question4": "식사 배달 지원"

    },
    "2.주거지원" :{
      "question1": "노인요양시설 신청 대상",
      "question2": "무료양로시설 신청 대상",
      "question3": "노인복지시설 신청",
      "question4": "요양 병원 및 요양원 관련 문의"
    },
    "3.건강의료" :{
      "question1": "틀니 지원 사업",
      "question2": "무릎 인공관절수술 지원",
      "question3": "치과임플란트 지원",
      "question4": "의치보철사업 지원"
    },
    "4.고용,일자리" :{
      "question1": "노인일자리 사업",
      "question2": "노인일자리 참여 신청 자격",
      "question3": "노인일자리 신청방법",
      "question4": "관련 문의"
    },
    "5.돌봄" :{
      "question1": "노인맞춤돌봄서비스",
      "question2": "자격 기준 및 신청방법",
      "question3": "응급안전 안심서비스",
      "question4": "노인 학대 신고"
    }
    
}];


options = ["1.생활지원", "2.주거지원", "3.건강의료", "4.고용,일자리", "5.돌봄","6.기타"];
var typearray=[];

    (function () {
    var Message;
    var count=0;
    Message = function (arg) {
        this.text = arg.text, this.message_side = arg.message_side;
        this.draw = function (_this) {
            return function () {
                var $message;
                $message = $($('.message_template').clone().html());
                $message.addClass(_this.message_side).find('.text').html(_this.text);
                $('.messages').append($message);
                return setTimeout(function () {
                    return $message.addClass('appeared');
                }, 0);
            };
        }(this);
        return this;
    };
    $(function () {
        var getMessageText, message_side, sendMessage;
        message_side = 'right';
        getMessageText = function () {
            var $message_input;
            $message_input = $('.message_input');
            if ($message_input==""){
              return False;
            }
            else{
              return $message_input.val();
            }
        };
        
        sendMessage = function (text) {
    var $messages, message;
    if (text.trim() === '') {
        return;
    }
    else if(options.includes(text)){
      console.log(text);
      typearray.push(text);
      
    }
    $('.message_input').val('');
    $messages = $('.messages');

    // 오른쪽에 위치
    var message_side = 'right';

    message = new Message({
        text: text,
        message_side: message_side
    });
  


// userMessage
    message.draw();
  

$.get("/get", { msg: text }).done(function(data) {
    var botMessage = new Message({
        text: data,
        message_side: 'left'
    });

    var writingMessage = new Message({
      text: '더 궁금하신 사항이 있으신가요? 추가 상담내용을 입력하지 않으면 1분 뒤 자동 종료됩니다.' +'<br><button id="done" class="done_button">종료</button>',
      message_side: 'left' 
    });


    var exampleMessage = new Message({
      text: data
            +'<br><button id="qes1" class="done_button">질문1</button>'
            +'<br><button id="qes2" class="done_button">질문2</button>'
            +'<br><button id="qes3" class="done_button">질문3</button>'
            +'<br><button id="qes4" class="done_button">질문4</button>',

      message_side: 'left' 
    });
    
    var checkMessage = new Message({
      text: '상담 전, 신원 확인을 위해 먼저 성함과 주민등록번호를 입력해주세요. 예) 홍길동, 660101-2345678',
      message_side: 'left' 
  });

  var donecheckMessage = new Message({
    text: '이용해주셔서 감사합니다.', 
    message_side: 'left' 
  });
    
    
    count+=1;
    if (count>2 && botMessage.text!= "잘못된 정보입니다. 다시 입력해주세요." && botMessage.text!="이용해주셔서 감사합니다."){
      //writingMessage.draw();
      //doneMessage.draw();
      botMessage.draw();
      writingMessage.draw();
      setTimeout(function() {
        alert("상담이 종료되었습니다");
        location.reload();
      }, 30000);
    }
    else if(count==1){
      botMessage.draw();
      checkMessage.draw();
    }
    else if("신원확인 되었습니다. 궁금하신 사항을 구체적으로 말씀해주세요. "==botMessage.text){
      for (var key in type_data[0]){
        console.log(key);
        if (typearray[0]==key){
          $(function(){
            $('#qes1').text(type_data[0][key]["question1"]);
            $('#qes2').text(type_data[0][key]["question2"]);
            $('#qes3').text(type_data[0][key]["question3"]);
            $('#qes4').text(type_data[0][key]["question4"]);
            $('#qes1').click(function (e) {
              var messageText = $(this).text();
              return sendMessage(messageText);
            });
            $('#qes2').click(function (e) {
              var messageText = $(this).text();
              return sendMessage(messageText);
            });
            $('#qes3').click(function (e) {
              var messageText = $(this).text();
              return sendMessage(messageText);
            });
            $('#qes4').click(function (e) {
              var messageText = $(this).text();
              return sendMessage(messageText);
            });
          });
          exampleMessage.draw();
          break;
        }
      }
      
      
    }
    else{
      botMessage.draw();
      writingMessage.draw();
    }

    $('#done').click(function (e) {
      donecheckMessage.draw();
      setTimeout(function() {
        location.reload();
      }, 3000)
      
    });
    $messages.animate({ scrollTop: $messages.prop('scrollHeight') }, 300);
    
});

return $messages.animate({ scrollTop: $messages.prop('scrollHeight') }, 300);
};

        

        $('.button').click(function (e) {
          location.reload();
        });

        $('.send_message').click(function (e) {
          if (getMessageText()!=false){
            $('.message_text').hide();
            $('.message_title').hide();
            return sendMessage(getMessageText());
          }
          else{
            window.alert("내용을 입력해주세요");
          }
        });

        //버튼 클릭시 
        $('.message_text').click(function (e) {
          var messageText = $(this).text();
          $('.message_text').hide();
          $('.message_title').hide();
          return sendMessage(messageText);
      });

        
        $('.message_text').click(function () {
          var messageText = $(this).text();
          //입력 후 엔터 시 동작
          $('.message_input').keyup(function (e) {
            if (e.which === 13) {
              $('.message_text').hide();
              $('.message_title').hide();
              return sendMessage(getMessageText());
            }
        });

        });
            

    });

    $(".copybutton").on("click", function(){
      // 캡쳐할 영역을 html2canvas로 캡쳐하여 canvas로 변환
      const capture = document.querySelector("#capture")
      capture.style.height = '3000px'
      html2canvas(capture).then(canvas => {
				saveImg(canvas.toDataURL('image/png'),"capture-test.png");
			});
    });

    // 캡쳐된 파일을 저장하는 함수
    function saveImg(uri, filename) { 
      var link = document.createElement('a'); 
      if (typeof link.download === 'string') { 
        link.href = uri; 
        link.download = filename; 
        document.body.appendChild(link); 
        link.click(); 
        document.body.removeChild(link); 
      } else { 
        window.open(uri); 
      } 
    }
    
}.call(this));

</script>


</body>
</html>